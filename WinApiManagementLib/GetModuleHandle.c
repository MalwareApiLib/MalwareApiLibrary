#include <Windows.h>
#include "Helper.h"
#include "ApiManagement.h"
#include "Structs.h"

#define MAX_DLLNAME			64


// exported
HMODULE GetModuleHandleByNameW(LPCWSTR lpModuleName) {
	if (lpModuleName == NULL) {
		return NULL;
	}
	PEB* pPeb = NULL;
	PLIST_ENTRY pListEntry = NULL;
	PLDR_DATA_TABLE_ENTRY pLdr = NULL;
	PLIST_ENTRY Head = NULL;
	PLIST_ENTRY Next = NULL;
	PPEB_LDR_DATA pLoaderData = NULL;
	WCHAR	wlpModuleName[MAX_DLLNAME];

	RfZeroMemory(wlpModuleName, sizeof(wlpModuleName));
	StringCopyW(wlpModuleName, lpModuleName);
	StringCopyW(wlpModuleName, CaplockStringW(wlpModuleName));


#ifdef _WIN64
	pPeb = (PPEB)__readgsqword(0x60);
#else
	pPeb = (PPEB)__readfsdword(0x30);
#endif // _WIN64

	if (pPeb == NULL) {
		return NULL;
	}

	pLdr = (PLDR_DATA_TABLE_ENTRY)pPeb->Ldr->InMemoryOrderModuleList.Flink;
	pListEntry = (PLIST_ENTRY)pPeb->Ldr->InMemoryOrderModuleList.Flink;
	pLoaderData = (PPEB_LDR_DATA)pPeb->Ldr;
	Head = (PLIST_ENTRY)&pLoaderData->InMemoryOrderModuleList;
	Next = (PLIST_ENTRY)Head->Flink;


	if (pLdr == NULL || pListEntry == NULL || pLoaderData == NULL || Head == NULL || Next == NULL) {
		return NULL;
	}

	while (Next != Head) {

		if (pLdr->FullDllName.Buffer != NULL && StringCompareW(CaplockStringW(pLdr->FullDllName.Buffer), wlpModuleName) == 0) {
			return (HMODULE)pLdr->InInitializationOrderLinks.Flink;
		}

		pListEntry = (PLIST_ENTRY)pListEntry->Flink;
		pLdr = (PLDR_DATA_TABLE_ENTRY)pListEntry->Flink;
		Next = (PLIST_ENTRY)Next->Flink;

	}

	return NULL;
}

//-----------------------------------------------------------------------------------------------------------------------------------------------------------
//-----------------------------------------------------------------------------------------------------------------------------------------------------------

// exported
HMODULE GetModuleHandleByNameA(PCHAR lpModuleName) {
	if (lpModuleName == NULL) {
		return NULL;
	}
	PEB* pPeb = NULL;
	PLIST_ENTRY pListEntry = NULL;
	PLDR_DATA_TABLE_ENTRY pLdr = NULL;
	PLIST_ENTRY Head = NULL;
	PLIST_ENTRY Next = NULL;
	PPEB_LDR_DATA pLoaderData = NULL;
	WCHAR	wlpModuleName[MAX_DLLNAME];

	RfZeroMemory(wlpModuleName, sizeof(wlpModuleName));
	CharStringToWCharString(wlpModuleName, lpModuleName, MAX_DLLNAME);
	StringCopyW(wlpModuleName, CaplockStringW(wlpModuleName));

#ifdef _WIN64
	pPeb = (PPEB)__readgsqword(0x60);
#else
	pPeb = (PPEB)__readfsdword(0x30);
#endif // _WIN64

	if (pPeb == NULL) {
		return NULL;
	}

	pLdr = (PLDR_DATA_TABLE_ENTRY)pPeb->Ldr->InMemoryOrderModuleList.Flink;
	pListEntry = (PLIST_ENTRY)pPeb->Ldr->InMemoryOrderModuleList.Flink;
	pLoaderData = (PPEB_LDR_DATA)pPeb->Ldr;
	Head = (PLIST_ENTRY)&pLoaderData->InMemoryOrderModuleList;
	Next = (PLIST_ENTRY)Head->Flink;


	if (pLdr == NULL || pListEntry == NULL || pLoaderData == NULL || Head == NULL || Next == NULL) {
		return NULL;
	}

	while (Next != Head) {

		if (pLdr->FullDllName.Buffer != NULL && StringCompareW(CaplockStringW(pLdr->FullDllName.Buffer), wlpModuleName) == 0) {
			return (HMODULE)pLdr->InInitializationOrderLinks.Flink;
		}

		pListEntry = (PLIST_ENTRY)pListEntry->Flink;
		pLdr = (PLDR_DATA_TABLE_ENTRY)pListEntry->Flink;
		Next = (PLIST_ENTRY)Next->Flink;

	}

	return NULL;

}

//-----------------------------------------------------------------------------------------------------------------------------------------------------------
//-----------------------------------------------------------------------------------------------------------------------------------------------------------


HMODULE GetModuleHandleByHash(INT Rotr32DllHash, INT Rotr32Seed) {
	if (Rotr32DllHash == NULL || Rotr32Seed == NULL) {
		return NULL;
	}
	PEB* pPeb = NULL;
	PLIST_ENTRY pListEntry = NULL;
	PLDR_DATA_TABLE_ENTRY pLdr = NULL;
	PLIST_ENTRY Head = NULL;
	PLIST_ENTRY Next = NULL;
	PPEB_LDR_DATA pLoaderData = NULL;

#ifdef _WIN64
	pPeb = (PPEB)__readgsqword(0x60);
#else
	pPeb = (PPEB)__readfsdword(0x30);
#endif // _WIN64

	if (pPeb == NULL) {
		return NULL;
	}

	pLdr = (PLDR_DATA_TABLE_ENTRY)pPeb->Ldr->InMemoryOrderModuleList.Flink;
	pListEntry = (PLIST_ENTRY)pPeb->Ldr->InMemoryOrderModuleList.Flink;
	pLoaderData = (PPEB_LDR_DATA)pPeb->Ldr;
	Head = (PLIST_ENTRY)&pLoaderData->InMemoryOrderModuleList;
	Next = (PLIST_ENTRY)Head->Flink;


	if (pLdr == NULL || pListEntry == NULL || pLoaderData == NULL || Head == NULL || Next == NULL) {
		return NULL;
	}

	while (Next != Head) {
		if (pLdr->FullDllName.Buffer != NULL && HashStringRotr32W(CaplockStringW(pLdr->FullDllName.Buffer), Rotr32Seed) == Rotr32DllHash) {
			return (HMODULE)pLdr->InInitializationOrderLinks.Flink;
		}

		pListEntry = (PLIST_ENTRY)pListEntry->Flink;
		pLdr = (PLDR_DATA_TABLE_ENTRY)pListEntry->Flink;
		Next = (PLIST_ENTRY)Next->Flink;

	}

	return NULL;

}
