#include <Windows.h>
#include "Helper.h"
#include "ApiManagement.h"
#include "Structs.h"


//-----------------------------------------------------------------------------------------------------------------------------------------------------------
//-----------------------------------------------------------------------------------------------------------------------------------------------------------

typedef struct DataStruct {
    PVOID                   pDll;
    PCHAR                   DllBaseAddr;
    PIMAGE_DOS_HEADER       pDosHeader;
    PIMAGE_NT_HEADERS       pNtHeaders;
    PIMAGE_OPTIONAL_HEADER  pOptionalHeader;
    PIMAGE_DATA_DIRECTORY   pDataDirectory;
    PIMAGE_EXPORT_DIRECTORY pExportDirectory;
    PVOID*                  ppFunctions;
    PWORD                   pOrdinals;
    PULONG                  pNames;
};

struct DataStruct ApiDataStruct = { 0 };


BOOL InitializeDataStruct(PVOID pDll) {

    PCHAR DllBaseAddr               = (char*)pDll;
    ApiDataStruct.pDll              = pDll;
    ApiDataStruct.DllBaseAddr       = (PIMAGE_DOS_HEADER)DllBaseAddr;
    ApiDataStruct.pDosHeader        = (PIMAGE_DOS_HEADER)DllBaseAddr;
    ApiDataStruct.pNtHeaders        = (PIMAGE_NT_HEADERS)(DllBaseAddr + ApiDataStruct.pDosHeader->e_lfanew);
    ApiDataStruct.pOptionalHeader   = (PIMAGE_OPTIONAL_HEADER)(&ApiDataStruct.pNtHeaders->OptionalHeader);
    ApiDataStruct.pDataDirectory    = (PIMAGE_DATA_DIRECTORY)(&ApiDataStruct.pOptionalHeader->DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT]);
    ApiDataStruct.pExportDirectory  = (PIMAGE_EXPORT_DIRECTORY)(DllBaseAddr + ApiDataStruct.pDataDirectory->VirtualAddress);
    ApiDataStruct.ppFunctions       = (void**)(DllBaseAddr + ApiDataStruct.pExportDirectory->AddressOfFunctions);
    ApiDataStruct.pOrdinals         = (WORD*)(DllBaseAddr + ApiDataStruct.pExportDirectory->AddressOfNameOrdinals);
    ApiDataStruct.pNames            = (ULONG*)(DllBaseAddr + ApiDataStruct.pExportDirectory->AddressOfNames);

    if (ApiDataStruct.pDll              == NULL   ||
        ApiDataStruct.DllBaseAddr       == NULL   ||
        ApiDataStruct.pDosHeader        == NULL   || 
        ApiDataStruct.pNtHeaders        == NULL   ||
        ApiDataStruct.pOptionalHeader   == NULL   || 
        ApiDataStruct.pDataDirectory    == NULL   || 
        ApiDataStruct.pExportDirectory  == NULL   ||
        ApiDataStruct.ppFunctions       == NULL   || 
        ApiDataStruct.pOrdinals         == NULL   || 
        ApiDataStruct.pNames            == NULL   ){

        return FALSE;
    }

    return TRUE;
}

//-----------------------------------------------------------------------------------------------------------------------------------------------------------
//-----------------------------------------------------------------------------------------------------------------------------------------------------------

// exported
PVOID GetProcAddressByName(PVOID pDll, PCHAR ApiName) {
    if (pDll == NULL || ApiName == NULL) {
        return NULL;
    }
    // update the dll we are searching in
    if (ApiDataStruct.pDll != pDll){
        if (!InitializeDataStruct(pDll)) {
            return NULL;
        }
    }

    for (DWORD i = 0; i < ApiDataStruct.pExportDirectory->NumberOfNames; i++) {
        PCHAR szName = (char*)ApiDataStruct.DllBaseAddr + (DWORD_PTR)ApiDataStruct.pNames[i];
        if (StringCompareA(szName, ApiName) == 0) {
            return (PVOID)(ApiDataStruct.DllBaseAddr + ((ULONG*)(ApiDataStruct.DllBaseAddr + ApiDataStruct.pExportDirectory->AddressOfFunctions))[ApiDataStruct.pOrdinals[i]]);
        }
    }
    return NULL;
}

//-----------------------------------------------------------------------------------------------------------------------------------------------------------
//-----------------------------------------------------------------------------------------------------------------------------------------------------------

// exported
PVOID GetProcAddressByHash(PVOID pDll, INT Rotr32ApiHash, INT Rotr32Seed) {
    if (pDll == NULL || Rotr32ApiHash == NULL || Rotr32Seed == NULL) {
        return NULL;
    }
    // update the dll we are searching in
    if (ApiDataStruct.pDll != pDll) {
        if (!InitializeDataStruct(pDll)) {
            return NULL;
        }
    }

    for (DWORD i = 0; i < ApiDataStruct.pExportDirectory->NumberOfNames; i++) {
        PCHAR szName = (char*)ApiDataStruct.DllBaseAddr + (DWORD_PTR)ApiDataStruct.pNames[i];
        if (HashStringRotr32A(szName, Rotr32Seed) == Rotr32ApiHash) {
            return (PVOID)(ApiDataStruct.DllBaseAddr + ((ULONG*)(ApiDataStruct.DllBaseAddr + ApiDataStruct.pExportDirectory->AddressOfFunctions))[ApiDataStruct.pOrdinals[i]]);
        }
    }
    return NULL;
}